## Product Quantizer

Product Quantizers（PQ, 乘积量化器）是一种用于近似最近邻搜索的数据压缩技术。它们通过将高维数据映射到低维表示来减少存储空间和计算复杂度，同时保持数据的相似性。这种方法特别适用于大规模数据集，如图像、音频或文本数据的相似性搜索。

乘积量化器的核心思想是将原始数据空间划分为多个子空间，每个子空间使用一个码本（codebook）来近似表示。码本中的每个码字对应于该子空间中的一个聚类中心。通过将数据投影到这些子空间并用相应的码字替换，可以实现数据的紧凑表示。

在实际应用中，乘积量化器可以显著提高最近邻搜索的效率，因为它们减少了需要比较的数据维度。这种方法在保持搜索精度的同时，降低了计算和存储成本，使其成为处理大规模数据集的有力工具。

### 名称含义

Product 指的是笛卡尔积（Cartesian Product），而 Quantizer 表示量化器。名称来源于该方法将高维向量空间分解为多个子空间的笛卡尔积，并对每个子空间独立进行量化（聚类），从而组合成最终的量化结果。

- 子空间分解：将高维向量切分为多个低维子空间，每个子空间单独量化
- 独立聚类：对每个子空间进行 K-means 聚类，生成一组聚类中心（码本）
- 组合编码：通过子空间聚类中心的笛卡尔积，表示原始向量，大幅降低存储和计算成本

### PQ的作用与示例

核心作用：高效压缩高维向量，加速近似最近邻搜索（ANN），适用于大规模数据集（如推荐系统、图像检索）

PQ通过牺牲少量精度，换取存储和计算效率的提升，是 Faiss 等库的核心技术之一。

#### 示例说明

假设有一个 128 维向量，用 PQ 压缩：
1. 分解：切分为 4 个子空间，每个子空间 32 维
2. 量化：对每个子空间进行 256-means 聚类，得到 4 个 32 维码本（每组256个聚类中心）
3. 编码：每个子向量用最近的聚类中心 ID （1字节）表示，最终压缩为 4 字节（原向量可能需 512 字节）
  - 256个聚类中心，ID 是 0~255 的整数，需 1 字节（256=2^8，刚好占 8bit）
  - 压缩后总字节数 = 子空间数 * 每个ID的字节数 = 4 * 1 = 4 字节
  - 原向量总字节数 = 128 * 4 = 512 字节（每个维度用 float32 表示，占用 4 字节）

搜索时：通过查表计算子空间距离，组合得到近似距离，避免全量计算

#### 典型应用场景

- 图像检索，如 Google 图片搜索
- 推荐系统，用户/物品嵌入向量快速匹配
- 自然语言处理，词向量相似度计算
